# Pipeline 思路

## 原始数据: pd.DataFrame

 index | QID | Brand | Model | Question | Dialogue | Report | 
 --- | --- |  ---  |  ---  |    ---   |    ---   |  --- | 
 0 | Q1 | 奔驰 | 奔驰GL级 | 方向机重，助力泵，方向机都换了还是一样 | 技师说：[语音]\|车主说：新的都换了\|车主说：助力泵，方向机\|技师说：[语音]\|车主说：换了... | 随时联系 | 
1|Q2|奔驰|奔驰M级| 奔驰ML500排气凸轮轴调节错误| 技师说：你这个有没有电脑检测故障代码。\|车主说：有\|技师说：发一下\|车主说：发动机之前亮故障...|随时联系
2|Q3|宝马|宝马X1(进口)| 2010款宝马X1，2011年出厂，2.0排量，通用6L45变速箱，原地换挡位PRND车辆闯...|技师说：你好，4缸自然吸气发动机N46是吧，先挂空档再挂其他档有没有闯动呢，变速箱油液位是否...|行驶没有顿挫的感觉，原地换挡有闯动，刹车踩重没有，这是力的限制的作用，应该没有问题
3|Q4|Jeep|牧马人|3.0V6发动机号在什么位置，有照片最好！|技师说：右侧排气管上方，缸体上靠近变速箱\|车主说：[图片]\|车主说：是不是这个？\|车主说：这...|举起车辆，在左前轮这边的缸体上
4|Q5|奔驰|奔驰C级| 2012款奔驰c180怎么样，维修保养，动力，值得拥有吗| 技师说：家庭用车的话，还是可以入手的\|技师说：维修保养费用不高\|车主说：12年的180市场价...|家庭用车可以入手的，维修保养价格还可以。车况好，价格合理可以入手

## 拆分 Question, Dialogue, Report (Report 在测试集中为空)
- [x] 除去无效项（NA)
- [x] 对话的处理与问题和报告不同
    - 包含多个句子
    - 车主说和技师说不规律地交替出现
    - 信息中有语音和图片（`[语音]` 和 `[图片]`）

## 分词（结巴分词）
- [x] 使用分词词典 `data/all_words.txt`
- [x] Question & Report:
    - 直接整句分词，每一句话变成 list of string
- [x] Dialogue：
    - 以 `|` 为分隔符将句子拆开，分词，然后重新组合变成一个 list of string
    - `[语音]` 与 `[图片]` 需要去掉，因为分词的时候没法整个分在一起

## 数据预处理

### 输入
- [x] 停用词表
- [x] 替换列表
- [x] 词频过滤阈值
- [x] 句子长度

### 过程
- [x] 过滤停用词
    - 停用词是直觉上对这个问答摘要任务没有帮助的词语，比如”你好“
    - 以及一些语气词，如”啊“， ”哦“ 等
- [x] 替换标点符号
    - 将标点符号统一替换方便处理
    - 比如将”。“，”。。“，。。。”，“……” 等全部替换成句末标识 `<EOS>`
    - 还有将全，半角符号统一处理
    - 将同一标识下的不同符号词频求和放回到词频列表中
- [x] 用分词结果建立词频表
    - 将句首`<START>`、句尾`<END>`、未知词`<UNK>`和填充符`<PAD>`加入词频表中，赋予默认词频（e.g. 100000000)
- [x] 过滤低频词
    - 低频词因为没有足够多的出现样式，嵌入向量不会很精确
    - 预测时也会遇到未出现在词表中的词，需要用这个向量代替
        - 预测时也可以用 Pointer-Generator Network （PGN）来解决 Out of Vocab （OOV）问题
    - 将词频低于阈值的词全部替换成 `<UNK>`
- [x] 添加句首，句尾标识
    - 这样预测的时候可以给定句首标识作为第一个词来开始，然后预测出句尾标识的时候就可以结束预测
    - 在每句话句首和句尾分别添加 `<START>`, `<END>`
- [x] 统一句子长度
    - 方便编码器输出统一尺寸的向量，否则无法进行 batch 训练
    - 将句子长度统一成设定的词数（包含各种标识）
    - 如果长度超过设定长度的话就把多出来的部分去掉，并将最后一个词替换成
    - 如果长度少于设定长度，用填充符 `<PAD>` 填充 `<END>` 后面的部分
- [ ] （Idea）将车主说和技师说的话分开保存
    - Ideas \#1, \#2
- [x] 将词频列表保存成 "Index Word Frequency" 格式，即为vocab
- [x] 添加两个可以把 index 和 word 相互映射的函数
- [x] 将分词以后的句子以空格作为分隔符保存

### 输出

- [x] 字典 vocab.yml
- [x] 预处理过，用空格作为分隔符拼接的 Question，Dialogue，Report

## 词嵌入

- [ ] 将文本载入以后用 vocab 将词替换成对应的编号（ index ）
- [ ] 用 gensim 来训练词嵌入向量
- [ ] 将训练好的词向量保存成 “Index x_1 x_2 ... x_n” 格式，其中“x_1 x_2 ... x_n” 即为编号为 Index 的词的词向量

## 模型训练

- [ ] 载入分好词的训练集，从空格分隔的 string 转换成 list ，然后映射到词编号
- [ ] 载入词向量
- [ ] 将训练集分成 train 和 validation set （也可以做cross validation）
- [ ] 每一个 batch 的 X 即为 Question & Dialogue 的拼接（或者分开 - Ideas \#1, \#2 ）， y 即为Report
    - report 中可能会有“随时联系”，也就是说模型需要学习在什么情况下问题是没有解决的（ Idea \#4）
- [ ] 在训练过程中定时在 validation set 上的一部分条目下进行预测，然后从词编号映射回单词以后进行比对来检测模型效果
    
## 模型测试

- [ ] 载入分好词的测试集，从空格分隔的 string 转换成 list ，然后映射到词编号
- [ ] 载入词向量
- [ ] 输入网络进行预测
- [ ] 输出损失函数值并记录

# 问题
- 如何有效的记录每次训练时用的都是什么网络和什么参数，以及结果？

# Ideas
1. 如果把车主说的话和技师说的话分别拼凑起来，在做总结的时候一起输入会不会更好？
    - 因为技师说的话偏向于解决，车主的话偏向于问题，在总结中可能起到不一样的效果
2. 将问题，对话，车主说的话和技师说的话分别用不同的网络处理，然后用一个更高层的注意力机制会不会更好？
    - 比如在总结的前半段会将更多注意力放在车主的问题上，而后半段更多放在解决方法上
3. 品牌和车型是否可以作为一个独立于 RNN 之外的输入来影响 Attention 或者 Decoder？
    - 比如不同车型的 attention 可能会不一样？
4. 如果需要推理哪些情况是没有解决问题需要随时联系的话可能对 RNN 来说就太难？
    - 可以考虑在训练中去掉那些随时联系的条目
    - 或者在输出的时候增加一个 confidence parameter ，然后如果信心比较低的话就输出“随时联系”
